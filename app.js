import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = "https://zdmseexyaqqrbbqupdxb.supabase.co";
const supabaseAnonKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkbXNlZXh5YXFxcmJicXVwZHgiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc1ODcxOTE3NCwiZXhwIjoyMDc0Mjk1MTc0fQ.lY13oD1DDmPxfY63UaWBh2R3_UsdMxTExesBBalVqFE";

const supabase = createClient(supabaseUrl, supabaseAnonKey);

let currentUser = null;

// Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
document.getElementById("registerBtn").addEventListener("click", async () => {
  const name = document.getElementById("name").value;
  const phone = document.getElementById("phone").value;
  const role = document.getElementById("role").value;

  const { data, error } = await supabase
    .from("users")
    .insert([{ name, phone, role }])
    .select();

  if (error) {
    alert("Ø®Ø·Ø£: " + error.message);
    return;
  }

  currentUser = data[0];
  document.getElementById("auth").style.display = "none";

  if (role === "customer") {
    document.getElementById("customer").style.display = "block";
  } else {
    document.getElementById("driver").style.display = "block";
    loadRides();
  }
});

// Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨
document.getElementById("rideBtn").addEventListener("click", async () => {
  const destination = document.getElementById("destination").value;

  const { data, error } = await supabase
    .from("rides")
    .insert([{ customer_id: currentUser.id, destination, status: "pending" }])
    .select();

  if (error) {
    alert("Ø®Ø·Ø£: " + error.message);
    return;
  }

  alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨!");
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø³Ø§Ø¦Ù‚
async function loadRides() {
  const { data, error } = await supabase
    .from("rides")
    .select("id, destination, status")
    .eq("status", "pending");

  if (error) {
    console.error(error);
    return;
  }

  const ridesList = document.getElementById("ridesList");
  ridesList.innerHTML = "";

  data.forEach((ride) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>ÙˆØ¬Ù‡Ø©:</b> ${ride.destination}<br>
      <button onclick="acceptRide('${ride.id}')">Ù‚Ø¨ÙˆÙ„</button>
    `;
    ridesList.appendChild(div);
  });
}

// Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨
window.acceptRide = async function (ride_id) {
  const { data, error } = await supabase
    .from("rides")
    .update({ status: "accepted", driver_id: currentUser.id })
    .eq("id", ride_id)
    .eq("status", "pending")
    .select();

  if (error) {
    alert("Ø®Ø·Ø£: " + error.message);
    return;
  }

  alert("ðŸš– ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨!");
  loadRides();
};
